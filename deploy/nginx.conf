# CORS: allow mobile dev (localhost + local IP), production, Capacitor, tunnels
map $http_origin $cors_origin {
    default "";
    "~^https://erp\.dincouture\.pk$" $http_origin;
    "~^https://supabase\.dincouture\.pk$" $http_origin;
    "~^http://localhost:5173$" $http_origin;
    "~^http://localhost:5174$" $http_origin;
    "~^http://127\.0\.0\.1:5173$" $http_origin;
    "~^http://127\.0\.0\.1:5174$" $http_origin;
    "~^http://192\.168\.\d+\.\d+:517[34]$" $http_origin;
    "~^http://10\.\d+\.\d+\.\d+:517[34]$" $http_origin;
    "~^http://172\.(1[6-9]|2\d|3[01])\.\d+\.\d+:517[34]$" $http_origin;
    "~^https://[a-z0-9-]+\.loca\.lt$" $http_origin;
    "~^https://[a-z0-9-]+\.lhr\.life$" $http_origin;
    "~^capacitor://localhost$" $http_origin;
    "~^ionic://localhost$" $http_origin;
    "~^https://localhost$" $http_origin;
}

server {
    listen 80;
    listen [::]:80;
    server_name erp.dincouture.pk;
    # Docker DNS: required for proxy_pass to resolve supabase-kong at runtime
    resolver 127.0.0.11 ipv6=off valid=10s;
    root /usr/share/nginx/html;
    index index.html;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # CORS headers for Supabase API (auth, rest, storage, realtime)
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, apikey, prefer, x-client-info, x-supabase-api-version, x-supabase-client-info, accept-profile, content-profile" always;
    add_header Access-Control-Max-Age 86400 always;

    # Supabase API: proxy to Kong so same-origin auth/rest return JSON not HTML
    # Hide upstream CORS headers (Kong sends *) to avoid duplicate values; we add our own
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Max-Age;

    location /auth/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        set $kong_upstream supabase-kong:8000;
        proxy_pass http://$kong_upstream/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /rest/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        set $kong_upstream supabase-kong:8000;
        proxy_pass http://$kong_upstream/rest/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /realtime/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        set $kong_upstream supabase-kong:8000;
        proxy_pass http://$kong_upstream/realtime/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_buffering off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }
    location /storage/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        set $kong_upstream supabase-kong:8000;
        proxy_pass http://$kong_upstream/storage/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Mobile PWA at /m
    location /m/ {
        alias /usr/share/nginx/html/m/;
        try_files $uri $uri/ /m/index.html;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    location = /m {
        return 301 /m/;
    }

    # SPA: all routes -> index.html (do not cache so browser gets latest JS/CSS hashes)
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    location = /index.html {
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # Cache static assets (hashed filenames)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
